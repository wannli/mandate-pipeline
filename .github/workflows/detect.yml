name: Detect Mandate Signals

on:
  push:
    paths:
      - 'data/extracted/**'
      - 'config/checks.yaml'
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: detect-${{ github.ref }}
  cancel-in-progress: false

jobs:
  analyze-changes:
    runs-on: ubuntu-latest
    outputs:
      extracted_files: ${{ steps.analyze.outputs.extracted_files }}
      config_changed: ${{ steps.analyze.outputs.config_changed }}
      run_mode: ${{ steps.analyze.outputs.run_mode }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Analyze what changed
        id: analyze
        run: |
          CONFIG_CHANGED=false
          EXTRACTED_FILES="[]"
          RUN_MODE="incremental"

          if [ "${{ github.event_name }}" = "push" ]; then
            # Check if config changed
            if git diff --name-only HEAD~1 HEAD | grep -q "config/checks.yaml"; then
              CONFIG_CHANGED=true
              RUN_MODE="full"
              echo "Config changed - running full detection"
            fi

            # Get changed extracted files
            CHANGED_EXTRACTED=$(git diff --name-only HEAD~1 HEAD -- data/extracted/*.json || echo "")
            if [ -n "$CHANGED_EXTRACTED" ]; then
              EXTRACTED_FILES=$(echo "$CHANGED_EXTRACTED" | jq -R -s 'split("\n") | map(select(. != ""))')
            fi
          else
            # Manual trigger - run on all extracted files
            RUN_MODE="full"
            if [ -d "data/extracted" ]; then
              EXTRACTED_FILES=$(find data/extracted -name "*.json" -type f | jq -R -s 'split("\n") | map(select(. != ""))')
            fi
          fi

          echo "config_changed=$CONFIG_CHANGED" >> $GITHUB_OUTPUT
          echo "extracted_files=$EXTRACTED_FILES" >> $GITHUB_OUTPUT
          echo "run_mode=$RUN_MODE" >> $GITHUB_OUTPUT

          echo "Run mode: $RUN_MODE"
          echo "Config changed: $CONFIG_CHANGED"
          echo "Files to process: $(echo "$EXTRACTED_FILES" | jq length)"

  detect:
    runs-on: ubuntu-latest
    needs: analyze-changes
    if: needs.analyze-changes.outputs.run_mode != '' && (needs.analyze-changes.outputs.extracted_files != '[]' || needs.analyze-changes.outputs.config_changed == 'true')
    strategy:
      matrix:
        extracted_file: ${{ fromJson(needs.analyze-changes.outputs.extracted_files) }}
        exclude:
          - ${{ needs.analyze-changes.outputs.run_mode == 'incremental' && needs.analyze-changes.outputs.extracted_files == '[]' }}
      max-parallel: 3
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -e .

      - name: Run signal detection
        run: |
          python -c "
          import sys
          import json
          sys.path.insert(0, 'src')
          from mandate_pipeline.detection import load_checks, run_checks
          from pathlib import Path

          extracted_file = Path('${{ matrix.extracted_file }}')
          if not extracted_file.exists():
              print(f'Extracted file not found: {extracted_file}')
              sys.exit(1)

          print(f'Detecting signals in: {extracted_file.name}')

          # Load extracted data
          with open(extracted_file) as f:
              doc_data = json.load(f)

          # Load detection config
          checks = load_checks(Path('config/checks.yaml'))

          # Run signal detection
          signals = run_checks(doc_data['paragraphs'], checks)

          # Create detection results
          detection_result = {
              'symbol': doc_data['symbol'],
              'signals': signals,
              'signal_summary': {}
          }

          # Create signal summary
          if signals:
              for para_signals in signals.values():
                  for signal in para_signals:
                      detection_result['signal_summary'][signal] = detection_result['signal_summary'].get(signal, 0) + 1

          # Save detection results
          output_file = Path('data/detected') / f'{extracted_file.stem}.json'
          output_file.parent.mkdir(parents=True, exist_ok=True)

          with open(output_file, 'w') as f:
              json.dump(detection_result, f, indent=2)

          print(f'Detection results saved to: {output_file}')
          print(f'Found signals: {list(detection_result[\"signal_summary\"].keys())}')
          "

      - name: Commit detection results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add data/detected/
          if git diff --staged --quiet; then
            echo "No detection changes to commit"
          else
            git commit -m "chore: detect signals in ${{ matrix.extracted_file }}"
            git pull --rebase origin main || true
            git push
          fi
{% extends "base.html" %}

{% block title %}Documents - Mandate Pipeline{% endblock %}

{% block nav_index %}../index.html{% endblock %}
{% block nav_documents %}./index.html{% endblock %}

{% block content %}
<!-- Header -->
<div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900 tracking-tight">All Documents</h1>
    <p class="mt-2 text-muted">{{ total_docs }} documents analyzed</p>
</div>

<!-- Filters -->
<div class="mb-6 flex flex-wrap items-center gap-4">
    <div class="flex items-center gap-2">
        <span class="text-sm text-muted">Filter:</span>
        <button onclick="filterBySignal('all')" id="btn-all"
                class="check-btn px-3 py-1.5 rounded-lg text-sm font-medium transition-all bg-gray-900 text-white">
            All
        </button>
        {% for check in checks %}
        <button onclick="filterBySignal('{{ check.signal }}')" id="btn-{{ check.signal|replace(' ', '-') }}"
                class="check-btn px-3 py-1.5 rounded-lg text-sm font-medium transition-all bg-gray-100 text-gray-700 hover:bg-gray-200">
            {{ check.signal }} ({{ total_signal_counts.get(check.signal, 0) }})
        </button>
        {% endfor %}
    </div>
    
    <div class="flex-1"></div>
    
    <div class="relative">
        <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
        <input type="text" id="search" placeholder="Search documents..." 
               class="pl-9 pr-4 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-un-blue focus:border-un-blue w-64"
               oninput="performSearch()">
    </div>
    <span class="text-sm text-muted"><span id="visibleCount">{{ total_docs }}</span> shown</span>
</div>

<!-- Documents Table -->
{% if documents %}
<div class="border border-gray-200 rounded-lg overflow-hidden">
    <table class="w-full" id="documentsTable">
        <thead>
            <tr class="bg-gray-50 border-b border-gray-200">
                <th class="text-left py-3 px-4 text-sm font-medium text-gray-500">Symbol</th>
                <th class="text-left py-3 px-4 text-sm font-medium text-gray-500">Pattern</th>
                <th class="text-center py-3 px-4 text-sm font-medium text-gray-500">Paragraphs</th>
                {% for check in checks %}
                <th class="text-center py-3 px-4 text-sm font-medium text-gray-500">{{ check.signal }}</th>
                {% endfor %}
                <th class="text-right py-3 px-4 text-sm font-medium text-gray-500">Actions</th>
            </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
            {% for doc in documents %}
            <tr class="doc-row hover:bg-gray-50 transition-colors"
                data-symbol="{{ doc.symbol|lower }}"
                data-signals='{{ doc.signal_summary|tojson }}'>
                <td class="py-3 px-4">
                    <a href="./{{ doc.symbol|replace('/', '_') }}.html" class="font-medium text-gray-900 hover:text-un-blue transition-colors">
                        {{ doc.symbol }}
                    </a>
                </td>
                <td class="py-3 px-4 text-sm text-muted">{{ doc.pattern_dir|replace('_', ' ') }}</td>
                <td class="text-center py-3 px-4 text-sm text-muted">{{ doc.num_paragraphs }}</td>
                {% for check in checks %}
                {% set count = doc.signal_summary.get(check.signal, 0) %}
                <td class="text-center py-3 px-4">
                    {% if count > 0 %}
                    <span class="inline-flex items-center justify-center min-w-[1.5rem] px-2 py-0.5 rounded-full text-xs font-medium
                        {% if 'agenda' in check.signal|lower %}bg-blue-50 text-blue-700
                        {% elif 'pga' in check.signal|lower %}bg-purple-50 text-purple-700
                        {% else %}bg-gray-100 text-gray-700{% endif %}">
                        {{ count }}
                    </span>
                    {% else %}
                    <span class="text-gray-300">—</span>
                    {% endif %}
                </td>
                {% endfor %}
                <td class="text-right py-3 px-4">
                    <a href="./{{ doc.symbol|replace('/', '_') }}.html" class="text-sm text-muted hover:text-un-blue transition-colors mr-3">View</a>
                    <a href="{{ doc.un_url }}" target="_blank" class="text-sm text-muted hover:text-un-blue transition-colors">PDF ↗</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% else %}
<div class="text-center py-16">
    <p class="text-muted">No documents found. Run the discovery pipeline to download documents.</p>
</div>
{% endif %}

<script>
let currentFilter = 'all';

function filterBySignal(signal) {
    currentFilter = signal;
    
    // Update button styles
    document.querySelectorAll('.check-btn').forEach(btn => {
        btn.classList.remove('bg-gray-900', 'text-white');
        btn.classList.add('bg-gray-100', 'text-gray-700');
    });
    
    const btnId = signal === 'all' ? 'btn-all' : `btn-${signal.replace(/ /g, '-')}`;
    const activeBtn = document.getElementById(btnId);
    if (activeBtn) {
        activeBtn.classList.remove('bg-gray-100', 'text-gray-700');
        activeBtn.classList.add('bg-gray-900', 'text-white');
    }
    
    applyFilters();
}

function performSearch() {
    applyFilters();
}

function applyFilters() {
    const searchTerm = document.getElementById('search').value.toLowerCase();
    const rows = document.querySelectorAll('.doc-row');
    let visible = 0;
    
    rows.forEach(row => {
        const symbol = row.dataset.symbol;
        const signals = JSON.parse(row.dataset.signals || '{}');
        
        let show = true;
        
        // Signal filter
        if (currentFilter !== 'all' && !signals[currentFilter]) {
            show = false;
        }
        
        // Search filter
        if (show && searchTerm && !symbol.includes(searchTerm)) {
            show = false;
        }
        
        row.style.display = show ? '' : 'none';
        if (show) visible++;
    });
    
    document.getElementById('visibleCount').textContent = visible;
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    filterBySignal('all');
});
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}Documents - Mandate Pipeline{% endblock %}

{% block nav_index %}../index.html{% endblock %}
{% block nav_documents %}./index.html{% endblock %}

{% block content %}
<!-- Header -->
<div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900 tracking-tight">Documents</h1>
    <p class="mt-2 text-muted">{{ total_docs }} documents analyzed</p>
</div>

<!-- Filters -->
<div class="mb-6 flex flex-wrap items-center gap-4">
    <!-- View Toggle -->
    <div class="flex items-center gap-2">
        <span class="text-sm text-muted">View:</span>
        <button onclick="setView('final')" id="btn-view-final"
                class="view-btn px-3 py-1.5 rounded-lg text-sm font-medium transition-all bg-gray-900 text-white">
            Final versions
        </button>
        <button onclick="setView('all')" id="btn-view-all"
                class="view-btn px-3 py-1.5 rounded-lg text-sm font-medium transition-all bg-gray-100 text-gray-700 hover:bg-gray-200">
            All
        </button>
    </div>

    <div class="w-px h-6 bg-gray-200"></div>

    <!-- Signal Filter -->
    <div class="flex items-center gap-2">
        <span class="text-sm text-muted">Signal:</span>
        <button onclick="filterBySignal('all')" id="btn-all"
                class="check-btn px-3 py-1.5 rounded-lg text-sm font-medium transition-all bg-gray-900 text-white">
            All
        </button>
        {% for check in checks %}
        <button onclick="filterBySignal('{{ check.signal }}')" id="btn-{{ check.signal|replace(' ', '-') }}"
                class="check-btn px-3 py-1.5 rounded-lg text-sm font-medium transition-all bg-gray-100 text-gray-700 hover:bg-gray-200">
            {{ check.signal }} ({{ total_signal_counts.get(check.signal, 0) }})
        </button>
        {% endfor %}
    </div>

    <div class="flex-1"></div>

    <div class="flex items-center gap-4">
        <div class="relative">
            <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            <input type="text" id="search" placeholder="Search documents..."
                   class="pl-9 pr-4 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-un-blue focus:border-un-blue w-64"
                   oninput="performSearch()">
        </div>
        <span class="text-sm text-muted"><span id="visibleCount">{{ total_docs }}</span> shown</span>
    </div>
</div>

<!-- Documents Table -->
<div class="border border-gray-200 rounded-lg overflow-hidden">
    <table class="w-full">
        <thead>
            <tr class="bg-gray-50 border-b border-gray-200">
                <th class="text-left py-3 px-4 text-xs font-medium text-gray-500 uppercase">Symbol</th>
                <th class="text-left py-3 px-4 text-xs font-medium text-gray-500 uppercase">Title</th>
                <th class="text-center py-3 px-4 text-xs font-medium text-gray-500 uppercase">Signals</th>
                <th class="text-center py-3 px-4 text-xs font-medium text-gray-500 uppercase">Status</th>
                <th class="text-right py-3 px-4 text-xs font-medium text-gray-500 uppercase">Actions</th>
            </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
            {% for doc in documents %}
            <tr class="doc-row hover:bg-gray-50 transition-colors {% if doc.status == 'superseded' %}superseded-row{% endif %}"
                data-symbol="{{ doc.symbol|lower }}"
                data-status="{{ doc.status }}"
                data-is-primary="{{ doc.is_primary|lower }}"
                data-signals='{{ doc.signal_summary|tojson }}'>
                <td class="py-3 px-4">
                    <div>
                        <a href="./{{ doc.symbol|replace('/', '_') }}.html"
                           class="font-medium {% if doc.status == 'superseded' %}text-gray-400{% else %}text-gray-900 hover:text-un-blue{% endif %} transition-colors">
                            {{ doc.symbol }}
                        </a>
                        {% if doc.status == 'adopted' and doc.linked_proposal_symbols %}
                        <div class="text-xs text-muted mt-0.5">
                            ← {{ doc.linked_proposal_symbols[0] }}
                        </div>
                        {% endif %}
                        {% if doc.status == 'superseded' and doc.linked_resolution_symbol %}
                        <div class="text-xs text-gray-400 mt-0.5">
                            → {{ doc.linked_resolution_symbol }}
                        </div>
                        {% endif %}
                    </div>
                </td>
                <td class="py-3 px-4">
                    <span class="text-sm {% if doc.status == 'superseded' %}text-gray-400{% else %}text-gray-600{% endif %} line-clamp-1">
                        {{ doc.title|default('—', true)|truncate(60) }}
                    </span>
                </td>
                <td class="text-center py-3 px-4">
                    {% if doc.signal_summary %}
                    <div class="flex flex-wrap justify-center gap-1">
                        {% for check in checks %}
                        {% set count = doc.signal_summary.get(check.signal, 0) %}
                        {% if count > 0 %}
                        <span class="inline-flex items-center justify-center min-w-[1.5rem] px-2 py-0.5 rounded-full text-xs font-medium
                            {% if 'agenda' in check.signal|lower %}bg-blue-50 text-blue-700
                            {% elif 'pga' in check.signal|lower %}bg-purple-50 text-purple-700
                            {% else %}bg-gray-100 text-gray-700{% endif %}">
                            {{ count }}
                        </span>
                        {% endif %}
                        {% endfor %}
                    </div>
                    {% else %}
                    <span class="text-gray-300">—</span>
                    {% endif %}
                </td>
                <td class="text-center py-3 px-4">
                    {% if doc.status == 'adopted' %}
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-50 text-green-700">
                        <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        Adopted
                    </span>
                    {% elif doc.status == 'draft' %}
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-amber-50 text-amber-700">
                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                        Draft
                    </span>
                    {% elif doc.status == 'superseded' %}
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-500">
                        Superseded
                    </span>
                    {% else %}
                    <span class="text-gray-300">—</span>
                    {% endif %}
                </td>
                <td class="text-right py-3 px-4">
                    <a href="./{{ doc.symbol|replace('/', '_') }}.html" class="text-sm text-muted hover:text-un-blue transition-colors mr-3">View</a>
                    <a href="{{ doc.un_url }}" target="_blank" class="text-sm text-muted hover:text-un-blue transition-colors">PDF ↗</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
let currentView = 'final';
let currentFilter = 'all';

function setView(view) {
    currentView = view;

    // Update view button styles
    document.querySelectorAll('.view-btn').forEach(btn => {
        btn.classList.remove('bg-gray-900', 'text-white');
        btn.classList.add('bg-gray-100', 'text-gray-700');
    });

    const activeBtn = document.getElementById(`btn-view-${view}`);
    if (activeBtn) {
        activeBtn.classList.remove('bg-gray-100', 'text-gray-700');
        activeBtn.classList.add('bg-gray-900', 'text-white');
    }

    applyFilters();
}

function filterBySignal(signal) {
    currentFilter = signal;

    // Update signal button styles
    document.querySelectorAll('.check-btn').forEach(btn => {
        btn.classList.remove('bg-gray-900', 'text-white');
        btn.classList.add('bg-gray-100', 'text-gray-700');
    });

    const btnId = signal === 'all' ? 'btn-all' : `btn-${signal.replace(/ /g, '-')}`;
    const activeBtn = document.getElementById(btnId);
    if (activeBtn) {
        activeBtn.classList.remove('bg-gray-100', 'text-gray-700');
        activeBtn.classList.add('bg-gray-900', 'text-white');
    }

    applyFilters();
}

function performSearch() {
    applyFilters();
}

function applyFilters() {
    const searchTerm = document.getElementById('search').value.toLowerCase();
    const rows = document.querySelectorAll('.doc-row');
    let visible = 0;

    rows.forEach(row => {
        const symbol = row.dataset.symbol;
        const status = row.dataset.status;
        const isPrimary = row.dataset.isPrimary === 'true';
        const signals = JSON.parse(row.dataset.signals || '{}');

        let show = true;

        // View filter (final versions vs all)
        if (currentView === 'final' && !isPrimary) {
            show = false;
        }

        // Signal filter
        if (show && currentFilter !== 'all' && !signals[currentFilter]) {
            show = false;
        }

        // Search filter
        if (show && searchTerm && !symbol.includes(searchTerm)) {
            show = false;
        }

        row.style.display = show ? '' : 'none';
        if (show) {
            visible++;
        }
    });

    // Update visible count
    document.getElementById('visibleCount').textContent = visible;
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    setView('final');
    filterBySignal('all');
});
</script>
{% endblock %}

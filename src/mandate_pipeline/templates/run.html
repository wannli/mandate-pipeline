{% extends "base.html" %}

{% block title %}Run Pipeline - UN Docs Downloader{% endblock %}

{% block content %}
<div class="mb-8">
    <h1 class="text-3xl font-bold text-slate-900">Run Pipeline</h1>
    <p class="mt-2 text-slate-600">Discover, download, and analyze UN documents</p>
</div>

<!-- Pattern Selection -->
<div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
    <h2 class="text-lg font-semibold text-slate-900 mb-4">Select Pattern</h2>
    
    {% if patterns %}
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        {% for pattern in patterns %}
        <button onclick="runPipeline({{ loop.index0 }}, '{{ pattern.name }}')"
                class="pattern-btn p-4 bg-slate-50 hover:bg-sky-50 border-2 border-slate-200 hover:border-sky-300 rounded-xl text-left transition-all group">
            <div class="font-semibold text-slate-900 group-hover:text-sky-700">{{ pattern.name }}</div>
            <code class="text-xs text-slate-500 mt-1 block">{{ pattern.template }}</code>
            <div class="text-xs text-slate-400 mt-2">Session {{ pattern.session }}</div>
        </button>
        {% endfor %}
    </div>
    
    <div class="flex items-center gap-4">
        <label class="flex items-center gap-2 text-sm text-slate-700">
            <span>Stop after</span>
            <input type="number" id="maxMisses" value="3" min="1" max="10" 
                   class="w-16 px-3 py-1.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
            <span>consecutive misses</span>
        </label>
    </div>
    {% else %}
    <div class="text-center py-8">
        <svg class="w-12 h-12 mx-auto text-slate-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        <p class="text-slate-600 mb-4">No patterns configured</p>
        <a href="/patterns" class="inline-flex items-center px-4 py-2 bg-sky-600 hover:bg-sky-700 text-white font-medium rounded-lg transition-colors">
            Configure Patterns
        </a>
    </div>
    {% endif %}
</div>

<!-- Results -->
<div id="resultsCard" class="hidden">
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-6">
        <div class="p-4 border-b border-slate-100 bg-gradient-to-r from-sky-50 to-white">
            <h2 class="text-lg font-semibold text-slate-900" id="runningTitle">Running...</h2>
        </div>
        
        <!-- Stats -->
        <div class="grid grid-cols-3 divide-x divide-slate-100 border-b border-slate-100">
            <div class="p-4 text-center">
                <div class="text-3xl font-bold text-emerald-600" id="foundCount">0</div>
                <div class="text-sm text-slate-500">Found</div>
            </div>
            <div class="p-4 text-center">
                <div class="text-3xl font-bold text-red-500" id="missCount">0</div>
                <div class="text-sm text-slate-500">Consecutive Misses</div>
            </div>
            <div class="p-4 text-center">
                <div class="text-3xl font-bold text-sky-600" id="signalCount">0</div>
                <div class="text-sm text-slate-500">Signals</div>
            </div>
        </div>
        
        <!-- Log -->
        <div id="log" class="h-80 overflow-y-auto p-4 bg-slate-900 font-mono text-sm"></div>
    </div>
    
    <!-- Summary Table -->
    <div id="summaryCard" class="hidden bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
        <div class="p-4 border-b border-slate-100 bg-slate-50">
            <h2 class="font-semibold text-slate-900">Results Summary</h2>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-slate-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Symbol</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Paragraphs</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Signals</th>
                    </tr>
                </thead>
                <tbody id="summaryBody" class="divide-y divide-slate-100"></tbody>
            </table>
        </div>
    </div>
</div>

<style>
#log .found { color: #34d399; }
#log .miss { color: #f87171; }
#log .signal { color: #60a5fa; }
#log .error { color: #ef4444; }
#log .complete { color: #fbbf24; font-weight: bold; }
#log .info { color: #94a3b8; }
</style>

<script>
let eventSource = null;
let results = [];

function runPipeline(patternIndex, patternName) {
    // Reset UI
    document.getElementById('resultsCard').classList.remove('hidden');
    document.getElementById('summaryCard').classList.add('hidden');
    document.getElementById('runningTitle').textContent = `Running: ${patternName}`;
    document.getElementById('log').innerHTML = '';
    document.getElementById('foundCount').textContent = '0';
    document.getElementById('missCount').textContent = '0';
    document.getElementById('signalCount').textContent = '0';
    results = [];
    
    const maxMisses = document.getElementById('maxMisses').value;
    
    // Close existing connection
    if (eventSource) {
        eventSource.close();
    }
    
    // Log start
    log('info', `Starting pipeline for ${patternName}...`);
    
    // Start new connection
    eventSource = new EventSource(`/api/run/${patternIndex}?max_misses=${maxMisses}`);
    
    let foundCount = 0;
    let missCount = 0;
    let signalCount = 0;
    
    eventSource.onmessage = function(event) {
        const data = JSON.parse(event.data);
        
        switch(data.type) {
            case 'found':
                foundCount++;
                document.getElementById('foundCount').textContent = foundCount;
                log('found', `Found: ${data.symbol}`);
                results.push({symbol: data.symbol, paragraphs: 0, signals: []});
                break;
                
            case 'downloaded':
                log('info', `  Downloaded: ${(data.size / 1024).toFixed(1)} KB`);
                break;
                
            case 'extracted':
                log('info', `  Extracted: ${data.paragraphs} paragraphs`);
                results[results.length - 1].paragraphs = data.paragraphs;
                break;
                
            case 'signals':
                const signalsFound = Object.values(data.results).flat();
                signalCount += signalsFound.length;
                document.getElementById('signalCount').textContent = signalCount;
                results[results.length - 1].signals = data.results;
                
                for (const [para, sigs] of Object.entries(data.results)) {
                    log('signal', `  Para ${para}: ${sigs.join(', ')}`);
                }
                break;
                
            case 'miss':
                missCount = data.consecutive;
                document.getElementById('missCount').textContent = missCount;
                log('miss', `Miss: ${data.symbol} (${data.consecutive} consecutive)`);
                break;
                
            case 'error':
                log('error', `Error: ${data.symbol} - ${data.error}`);
                break;
                
            case 'complete':
                document.getElementById('runningTitle').textContent = `Complete: ${patternName}`;
                log('complete', `Pipeline complete! Found ${data.found} documents.`);
                eventSource.close();
                showSummary();
                break;
        }
    };
    
    eventSource.onerror = function() {
        log('error', 'Connection lost');
        eventSource.close();
    };
}

function log(type, message) {
    const logEl = document.getElementById('log');
    const line = document.createElement('div');
    line.className = type;
    line.textContent = message;
    logEl.appendChild(line);
    logEl.scrollTop = logEl.scrollHeight;
}

function showSummary() {
    const card = document.getElementById('summaryCard');
    const body = document.getElementById('summaryBody');
    
    body.innerHTML = '';
    
    for (const result of results) {
        const signals = result.signals;
        let signalHtml = '';
        
        if (Object.keys(signals).length > 0) {
            for (const [para, sigs] of Object.entries(signals)) {
                signalHtml += `<div class="mb-1">Para ${para}: ${sigs.map(s => {
                    let colorClass = 'bg-slate-100 text-slate-700';
                    if (s.toLowerCase().includes('agenda')) colorClass = 'bg-blue-100 text-blue-700';
                    else if (s.toLowerCase().includes('pga')) colorClass = 'bg-purple-100 text-purple-700';
                    else if (s.toLowerCase().includes('sg')) colorClass = 'bg-amber-100 text-amber-700';
                    else if (s.toLowerCase().includes('follow')) colorClass = 'bg-rose-100 text-rose-700';
                    return `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${colorClass}">${s}</span>`;
                }).join(' ')}</div>`;
            }
        } else {
            signalHtml = '<span class="text-slate-400 text-sm">None</span>';
        }
        
        body.innerHTML += `
            <tr class="hover:bg-slate-50">
                <td class="px-4 py-3 font-medium text-slate-900">${result.symbol}</td>
                <td class="px-4 py-3 text-slate-600">${result.paragraphs}</td>
                <td class="px-4 py-3">${signalHtml}</td>
            </tr>
        `;
    }
    
    card.classList.remove('hidden');
}
</script>
{% endblock %}
